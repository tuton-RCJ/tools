<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Robot Buzzer Music Maker (C4-C6)</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        h1 { color: #333; margin-bottom: 10px; }

        .controls { 
            background: white; padding: 15px 25px; border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
            justify-content: center;
        }

        .control-item { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #555; }
        input[type="text"], input[type="number"] { padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; }

        .editor-outer {
            width: 100%;
            max-width: 1200px;
            height: 600px; /* C6追加に伴い少し高く設定 */
            overflow: auto;
            border: 2px solid #444;
            background: #fff;
        }

        .note-row {
            display: flex;
            height: 28px;
            border-bottom: 1px solid #eee;
        }

        .key {
            position: sticky;
            left: 0;
            width: 100px;
            min-width: 100px;
            height: 100%;
            background: white;
            border-right: 2px solid #444;
            display: flex;
            align-items: center;
            padding-left: 10px;
            font-size: 11px;
            font-weight: bold;
            z-index: 2;
            cursor: pointer;
            user-select: none;
        }
        .key.black { background: #333; color: white; }
        .key.octave-c { background: #e3f2fd; color: #1976d2; border-left: 4px solid #1976d2; }

        .cells-container { display: flex; }

        .cell {
            width: 30px;
            min-width: 30px;
            height: 100%;
            border-right: 1px solid #eee;
            cursor: pointer;
        }
        /* 4マス(1拍)・16マス(1小節)ごとの区切りを強調 */
        .cell:nth-child(4n) { border-right: 1px solid #bbb; }
        .cell:nth-child(16n) { border-right: 3px solid #888; }
        
        .cell.active { background-color: #4CAF50; box-shadow: inset 0 0 4px rgba(0,0,0,0.3); }
        .cell:hover { background-color: #e8f5e9; }

        .output-area { margin-top: 20px; width: 100%; max-width: 1200px; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        textarea { width: 100%; height: 250px; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; border: 1px solid #ccc; border-radius: 5px; background: #2d2d2d; color: #f8f8f2; font-size: 13px; line-height: 1.4; overflow-y: scroll; }
        
        button { 
            padding: 8px 16px; cursor: pointer; border: none; border-radius: 5px; 
            font-weight: bold; transition: 0.2s;
        }
        .btn-play { background: #4CAF50; color: white; }
        .btn-export { background: #E91E63; color: white; }
        .btn-copy { background: #607D8B; color: white; font-size: 12px; }
        button:hover { opacity: 0.8; }
    </style>
</head>
<body>

    <h1>Robot Buzzer Music Maker</h1>

    <div class="controls">
        <div class="control-item">
            変数名: <input type="text" id="varName" value="music_sample" style="width: 150px;">
        </div>
        <div class="control-item">
            Music ID: <input type="number" id="musicID" value="1" style="width: 45px;">
        </div>
        <div class="control-item">
            1マス: <input type="number" id="stepDuration" value="150" style="width: 60px;"> ms
        </div>
        <button class="btn-play" onclick="playPreview()">▶ 再生確認</button>
        <button class="btn-export" onclick="exportPython()">Pythonコード生成</button>
    </div>

    <div class="editor-outer">
        <div id="editor-body"></div>
    </div>

    <div class="output-area">
        <div class="output-header">
            <strong>Python MusicData Code:</strong>
            <button class="btn-copy" onclick="copyToClipboard()">コードをコピー</button>
        </div>
        <textarea id="pythonOutput" readonly placeholder="# ボタンを押すとここにMusicDataが生成されます..."></textarea>
    </div>

    <script>
        const STEPS = 96; // 4拍子 × 6小節分
        const stepDurationInput = document.getElementById('stepDuration');
        const musicIDInput = document.getElementById('musicID');
        const varNameInput = document.getElementById('varName');
        
        // 音階定義 (C6 ～ C4)
        const NOTE_NAMES = [
            { name: "C6", freq: 1047 },
            { name: "B5", freq: 988 }, { name: "A#5", freq: 932 }, { name: "A5", freq: 880 },
            { name: "G#5", freq: 831 }, { name: "G5", freq: 784 }, { name: "F#5", freq: 740 },
            { name: "F5", freq: 698 }, { name: "E5", freq: 659 }, { name: "D#5", freq: 622 },
            { name: "D5", freq: 587 }, { name: "C#5", freq: 554 }, { name: "C5", freq: 523 },
            { name: "B4", freq: 494 }, { name: "A#4", freq: 466 }, { name: "A4", freq: 440 },
            { name: "G#4", freq: 415 }, { name: "G4", freq: 392 }, { name: "F#4", freq: 370 },
            { name: "F4", freq: 349 }, { name: "E4", freq: 330 }, { name: "D#4", freq: 311 },
            { name: "D4", freq: 294 }, { name: "C#4", freq: 277 }, { name: "C4", freq: 262 }
        ];

        let gridData = Array(NOTE_NAMES.length).fill().map(() => Array(STEPS).fill(false));
        const editorBody = document.getElementById('editor-body');

        // エディタの初期化
        NOTE_NAMES.forEach((note, rowIndex) => {
            const rowEl = document.createElement('div');
            rowEl.className = 'note-row';
            
            const keyEl = document.createElement('div');
            let keyClass = `key ${note.name.includes('#') ? 'black' : ''}`;
            if(note.name.startsWith('C') && !note.name.includes('#')) keyClass += ' octave-c';
            keyEl.className = keyClass;
            keyEl.innerText = note.name;
            keyEl.onmousedown = () => beep(note.freq, 200);
            rowEl.appendChild(keyEl);

            const cellsContainer = document.createElement('div');
            cellsContainer.className = 'cells-container';
            for (let colIndex = 0; colIndex < STEPS; colIndex++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => {
                    // 同一列の単音化
                    for(let r=0; r < NOTE_NAMES.length; r++) {
                        if(r !== rowIndex && gridData[r][colIndex]) {
                            gridData[r][colIndex] = false;
                            editorBody.children[r].querySelector('.cells-container').children[colIndex].classList.remove('active');
                        }
                    }
                    gridData[rowIndex][colIndex] = !gridData[rowIndex][colIndex];
                    cell.classList.toggle('active');
                    if (gridData[rowIndex][colIndex]) beep(note.freq, 100);
                };
                cellsContainer.appendChild(cell);
            }
            rowEl.appendChild(cellsContainer);
            editorBody.appendChild(rowEl);
        });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq, duration) {
            if (freq === 0) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration/1000);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration/1000);
        }

        function exportPython() {
            const stepMs = parseInt(stepDurationInput.value);
            const musicID = parseInt(musicIDInput.value);
            const varName = varNameInput.value.trim() || `music_data_${musicID}`;
            let notes = [];

            for (let c = 0; c < STEPS; c++) {
                let currentFreq = 0;
                for (let r = 0; r < NOTE_NAMES.length; r++) {
                    if (gridData[r][c]) {
                        currentFreq = NOTE_NAMES[r].freq;
                        break;
                    }
                }
                if (notes.length > 0 && notes[notes.length - 1][0] === currentFreq) {
                    notes[notes.length - 1][1] += stepMs;
                } else {
                    notes.push([currentFreq, stepMs]);
                }
            }

            // 末尾の休符カット
            while (notes.length > 0 && notes[notes.length - 1][0] === 0) {
                notes.pop();
            }

            if (notes.length === 0) {
                document.getElementById('pythonOutput').value = "# 音符が入力されていません";
                return;
            }

            let pythonCode = `${varName} = MusicData(\n`;
            pythonCode += `    musicID=${musicID},\n`;
            pythonCode += `    notes=[\n`;
            notes.forEach((note, index) => {
                const isLast = index === notes.length - 1;
                pythonCode += `        [${note[0]}, ${note[1]}]${isLast ? "" : ","}\n`;
            });
            pythonCode += `    ]\n`;
            pythonCode += `)`;

            document.getElementById('pythonOutput').value = pythonCode;
        }

        function copyToClipboard() {
            const textarea = document.getElementById('pythonOutput');
            if(!textarea.value || textarea.value.startsWith('#')) return;
            textarea.select();
            document.execCommand('copy');
            alert('クリップボードにコピーしました！');
        }

        async function playPreview() {
            const stepMs = parseInt(stepDurationInput.value);
            for (let c = 0; c < STEPS; c++) {
                let found = false;
                for (let r = 0; r < NOTE_NAMES.length; r++) {
                    if (gridData[r][c]) {
                        beep(NOTE_NAMES[r].freq, stepMs);
                        found = true;
                        break;
                    }
                }
                // 視覚的なフィードバック（任意）
                await new Promise(r => setTimeout(r, stepMs));
            }
        }
    </script>
</body>
</html>